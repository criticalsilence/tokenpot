<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TokenPot - Web3 Slot Makinesi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Koyu tema arka planı */
            color: #e0e0e0; /* Açık renk metin */
        }
        .slot-machine-container {
            background: linear-gradient(145deg, #1f1f38, #2a2a4c);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid #3a3a5c;
        }
        .reel {
            width: 100px; /* Genişletilmiş makara */
            height: 120px; /* Yüksekliği artırılmış makara */
            background-color: #2c2c44;
            border: 2px solid #4a4a6c;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 50px; /* Sembol boyutu büyütüldü */
            overflow: hidden;
            position: relative;
        }
        .reel-symbols {
            transition: transform 0.1s ease-in-out;
        }
        .reel-symbol {
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .connect-wallet-btn, .spin-btn, .history-link-btn, .disconnect-wallet-btn {
            background: linear-gradient(to right, #7f00ff, #e100ff); /* Mor-pembe gradient */
            color: white;
            font-weight: bold;
            padding: 12px 25px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(192, 0, 255, 0.3);
        }
        .connect-wallet-btn:hover, .spin-btn:hover, .history-link-btn:hover, .disconnect-wallet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(192, 0, 255, 0.5);
        }
        .disconnect-wallet-btn {
            background: linear-gradient(to right, #ff7f00, #ffc100); /* Turuncu gradient */
            padding: 8px 15px; /* Daha küçük buton */
            font-size: 0.9em;
            margin-left: 10px;
        }
        .connect-wallet-btn:disabled, .spin-btn:disabled {
            background: #4a4a6c;
            cursor: not-allowed;
            box-shadow: none;
        }
        .bet-input {
            background-color: #2c2c44;
            border: 1px solid #4a4a6c;
            color: #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }
        .tx-item {
            background-color: #25253f;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            border-left: 4px solid;
        }
        .tx-win {
            border-left-color: #28a745; /* Yeşil */
        }
        .tx-lose {
            border-left-color: #dc3545; /* Kırmızı */
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-win {
            background-color: #28a745;
        }
        .status-lose {
            background-color: #dc3545;
        }
        .pool-display, .wallet-info {
            background-color: #25253f;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid #3a3a5c;
        }
        .game-rules, .github-link {
            font-size: 0.9em;
            color: #a0a0c0;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div class="slot-machine-container w-full max-w-3xl">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 via-pink-500 to-red-500">TokenPot</h1>
            <button id="connectWalletBtn" class="connect-wallet-btn">Cüzdana Bağlan</button>
        </header>

        <div id="walletInfo" class="wallet-info hidden">
            <div class="flex justify-center items-center">
                <div>
                    <p>Bağlı Adres: <span id="userAddress" class="font-mono"></span></p>
                    <p>Ağ: <span id="networkName" class="font-mono"></span></p>
                </div>
                <button id="disconnectWalletBtn" class="disconnect-wallet-btn">Çıkış Yap</button>
            </div>
        </div>

        <div class="pool-display">
            <h2 class="text-xl font-semibold">Havuzda Biriken ETH (Kontrat Bakiyesi)</h2>
            <p id="poolBalance" class="text-3xl font-bold">0.00 ETH</p>
        </div>
        
        <main class="flex flex-col md:flex-row items-center md:items-start justify-around gap-6">
            <div class="flex flex-col items-center">
                <div class="flex space-x-4 mb-6">
                    <div id="reel1" class="reel"><div class="reel-symbols">❓</div></div>
                    <div id="reel2" class="reel"><div class="reel-symbols">❓</div></div>
                    <div id="reel3" class="reel"><div class="reel-symbols">❓</div></div>
                </div>

                <div class="flex flex-col items-center space-y-4 w-full max-w-xs">
                    <input type="number" id="betAmountInput" placeholder="ETH Bahis Miktarı" class="bet-input w-full" step="0.01" min="0.01">
                    <button id="spinBtn" class="spin-btn w-full" disabled>Çevir!</button>
                </div>
                <p id="spinResult" class="mt-4 text-lg h-6"></p> <div class="mt-4 text-center">
                    <p class="game-rules text-sm">Oyun Kuralları: 3 aynı kazanan sembolü yakala! Kazançlardan %5 işletme ücreti alınır.</p>
                    <a href="https://github.com/criticalsilence/tokenpot" target="_blank" class="github-link text-purple-400 hover:text-purple-300 underline">GitHub'da Açık Kaynak Kodları</a>
                </div>
            </div>

            <div class="w-full md:w-2/5">
                <h2 class="text-2xl font-semibold mb-3 text-center md:text-left">Son İşlemler</h2>
                <div id="transactionList" class="space-y-2 max-h-[280px] overflow-y-auto pr-2"> </div>
                <div class="mt-4 text-center">
                     <a href="history.html" class="history-link-btn inline-block">Tüm İşlem Geçmişi</a>
                </div>
            </div>
        </main>
    </div>

    <div id="notificationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 id="notificationTitle" class="text-xl font-semibold mb-3">Bildirim</h3>
            <p id="notificationMessage" class="mb-4"></p>
            <button id="closeNotificationBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded w-full">Kapat</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const YOUR_CONTRACT_ADDRESS = "0x18A541bf5174Cd930b5430199560Ac358c6dB077"; 
        const YOUR_CONTRACT_ABI = [
          {
            "inputs": [
              {
                "internalType": "uint256",
                "name": "_minimumBet",
                "type": "uint256"
              }
            ],
            "stateMutability": "nonpayable",
            "type": "constructor"
          },
          {
            "anonymous": false,
            "inputs": [
              {
                "indexed": true,
                "internalType": "bytes32",
                "name": "requestId",
                "type": "bytes32"
              },
              {
                "indexed": true,
                "internalType": "address",
                "name": "player",
                "type": "address"
              }
            ],
            "name": "SpinRequested",
            "type": "event"
          },
          {
            "anonymous": false,
            "inputs": [
              {
                "indexed": true,
                "internalType": "bytes32",
                "name": "requestId",
                "type": "bytes32"
              },
              {
                "indexed": true,
                "internalType": "address",
                "name": "player",
                "type": "address"
              },
              {
                "indexed": false,
                "internalType": "uint256",
                "name": "betAmount",
                "type": "uint256"
              },
              {
                "indexed": false,
                "internalType": "uint256",
                "name": "prizeAmount",
                "type": "uint256"
              },
              {
                "indexed": false,
                "internalType": "uint8[3]",
                "name": "resultSymbols",
                "type": "uint8[3]"
              }
            ],
            "name": "SpinResult",
            "type": "event"
          },
          {
            "inputs": [],
            "name": "betAndSpin",
            "outputs": [],
            "stateMutability": "payable",
            "type": "function"
          },
          {
            "inputs": [],
            "name": "minimumBet",
            "outputs": [
              {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
              }
            ],
            "stateMutability": "view",
            "type": "function"
          },
          {
            "inputs": [],
            "name": "operatorFeePercent",
            "outputs": [
              {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
              }
            ],
            "stateMutability": "view",
            "type": "function"
          },
          {
            "inputs": [],
            "name": "owner",
            "outputs": [
              {
                "internalType": "address",
                "name": "",
                "type": "address"
              }
            ],
            "stateMutability": "view",
            "type": "function"
          },
          {
            "inputs": [
              {
                "internalType": "bytes32",
                "name": "",
                "type": "bytes32"
              }
            ],
            "name": "spinRequests",
            "outputs": [
              {
                "internalType": "address",
                "name": "",
                "type": "address"
              }
            ],
            "stateMutability": "view",
            "type": "function"
          },
          {
            "inputs": [],
            "name": "withdrawFees",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
          }
        ];
        
        const TARGET_CHAIN_ID_DECIMAL = '300'; 
        const TARGET_CHAIN_ID_HEX = '0x12c'; // zkSync Sepolia Chain ID (Hexadecimal)
        const TARGET_NETWORK_NAME = 'zkSync Sepolia Testnet';
        // Aşağıdaki RPC ve Explorer URL'leri, ağı otomatik ekleme özelliği için kullanılır.
        const ZKSYNC_SEPOLIA_RPC_URL = 'https://sepolia.era.zksync.dev'; 
        const ZKSYNC_SEPOLIA_EXPLORER_URL = 'https://sepolia.explorer.zksync.io/';

        const SYMBOLS_EMOJI = ['🍒', '🍋', '🍊', '🍇', '⭐', '🔔', '🍉', '🍀', '💎', '7️⃣', '🅱️'];
        
        // --- DOM ELEMENTS ---
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const disconnectWalletBtn = document.getElementById('disconnectWalletBtn'); 
        const spinBtn = document.getElementById('spinBtn');
        const betAmountInput = document.getElementById('betAmountInput');
        const reels = [
            document.getElementById('reel1').querySelector('.reel-symbols'), 
            document.getElementById('reel2').querySelector('.reel-symbols'), 
            document.getElementById('reel3').querySelector('.reel-symbols')
        ];
        const poolBalanceEl = document.getElementById('poolBalance');
        const transactionListEl = document.getElementById('transactionList');
        const userAddressEl = document.getElementById('userAddress');
        const networkNameEl = document.getElementById('networkName');
        const walletInfoEl = document.getElementById('walletInfo');
        const spinResultEl = document.getElementById('spinResult');
        
        const notificationModal = document.getElementById('notificationModal');
        const notificationTitle = document.getElementById('notificationTitle');
        const notificationMessage = document.getElementById('notificationMessage');
        const closeNotificationBtn = document.getElementById('closeNotificationBtn');

        // --- STATE ---
        let provider;
        let signer;
        let currentUserAddress;
        let tokenPotContract;
        let transactions = []; 

        // --- LOCALSTORAGE ---
        function loadLocalTransactions() {
            const storedTransactions = localStorage.getItem('tokenpot_local_transactions');
            if (storedTransactions) {
                transactions = JSON.parse(storedTransactions);
            }
            renderTransactionList();
        }

        function saveLocalTransactions() {
            localStorage.setItem('tokenpot_local_transactions', JSON.stringify(transactions));
        }
        
        // --- NOTIFICATIONS ---
        function showNotification(title, message) {
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            notificationModal.classList.remove('hidden');
        }

        closeNotificationBtn.addEventListener('click', () => {
            notificationModal.classList.add('hidden');
        });

        // --- WEB3 FUNCTIONS ---
        async function switchToCorrectNetwork() {
            if (!window.ethereum) {
                showNotification('MetaMask Yok', 'Lütfen MetaMask eklentisini kurun veya etkinleştirin.');
                return false;
            }
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: TARGET_CHAIN_ID_HEX }],
                });
                return true;
            } catch (switchError) {
                if (switchError.code === 4902) { // Ağ MetaMask'te tanımlı değilse
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [
                                {
                                    chainId: TARGET_CHAIN_ID_HEX,
                                    chainName: TARGET_NETWORK_NAME,
                                    rpcUrls: [ZKSYNC_SEPOLIA_RPC_URL],
                                    nativeCurrency: {
                                        name: 'Ethereum',
                                        symbol: 'ETH',
                                        decimals: 18,
                                    },
                                    blockExplorerUrls: [ZKSYNC_SEPOLIA_EXPLORER_URL],
                                },
                            ],
                        });
                        return true; // Ağı ekledikten sonra tekrar switch denemeye gerek yok, genellikle otomatik geçer.
                    } catch (addError) {
                        console.error("Ağ ekleme hatası:", addError);
                        showNotification('Ağ Eklenemedi', `MetaMask'e ${TARGET_NETWORK_NAME} ağı eklenemedi. Hata: ${addError.message}`);
                        return false;
                    }
                } else {
                    console.error("Ağ değiştirme hatası:", switchError);
                    showNotification('Ağ Değiştirilemedi', `${TARGET_NETWORK_NAME} ağına geçiş yapılamadı. Lütfen MetaMask üzerinden manuel olarak ağı değiştirin.`);
                    return false;
                }
            }
        }

        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    provider = new ethers.BrowserProvider(window.ethereum);
                    
                    // Önce kullanıcıdan hesap izni iste
                    await provider.send("eth_requestAccounts", []); 
                    
                    let network = await provider.getNetwork();
                    if (network.chainId.toString() !== TARGET_CHAIN_ID_DECIMAL) {
                        showNotification('Ağ Değiştiriliyor...', `${TARGET_NETWORK_NAME} ağına geçiş yapılıyor. Lütfen MetaMask'teki istemi onaylayın.`);
                        const switched = await switchToCorrectNetwork();
                        if (!switched) {
                            disconnectWalletLogic();
                            return; 
                        }
                        // Ağ değiştikten sonra provider ve network bilgilerini yeniden al
                        provider = new ethers.BrowserProvider(window.ethereum); 
                        network = await provider.getNetwork(); 
                        if (network.chainId.toString() !== TARGET_CHAIN_ID_DECIMAL) {
                            showNotification('Hata', `${TARGET_NETWORK_NAME} ağına geçiş yapılamadı. Lütfen manuel olarak kontrol edin.`);
                            disconnectWalletLogic();
                            return;
                        }
                    }
                    
                    signer = await provider.getSigner();
                    currentUserAddress = await signer.getAddress();

                    walletInfoEl.classList.remove('hidden');
                    userAddressEl.textContent = `${currentUserAddress.substring(0, 6)}...${currentUserAddress.substring(currentUserAddress.length - 4)}`;
                    networkNameEl.textContent = TARGET_NETWORK_NAME;
                    connectWalletBtn.classList.add('hidden'); 
                    disconnectWalletBtn.classList.remove('hidden'); 
                    
                    tokenPotContract = new ethers.Contract(YOUR_CONTRACT_ADDRESS, YOUR_CONTRACT_ABI, signer);
                    spinBtn.disabled = false;
                    showNotification('Başarılı', 'Cüzdan başarıyla bağlandı ve kontrat yüklendi!');
                    updatePoolBalance(); 
                    listenForContractEvents(); 

                } catch (error) {
                    console.error("Cüzdan bağlantı hatası:", error);
                    let friendlyMessage = "Cüzdan bağlantısı kurulamadı.";
                    if (error.code === 4001) { 
                        friendlyMessage = "İstek kullanıcı tarafından reddedildi.";
                    } else if (error.message) {
                        friendlyMessage += ` Detay: ${error.message.substring(0, 100)}...`;
                    }
                    showNotification('Hata', friendlyMessage);
                    disconnectWalletLogic();
                }
            } else {
                showNotification('MetaMask Yok', 'Lütfen MetaMask eklentisini kurun veya etkinleştirin.');
            }
        }
        
        function disconnectWalletLogic() {
            provider = null;
            signer = null;
            currentUserAddress = null;
            if (tokenPotContract) {
                tokenPotContract.removeAllListeners("SpinResult");
            }
            tokenPotContract = null;
            walletInfoEl.classList.add('hidden');
            userAddressEl.textContent = '';
            networkNameEl.textContent = '';
            connectWalletBtn.classList.remove('hidden'); 
            disconnectWalletBtn.classList.add('hidden'); 
            spinBtn.disabled = true;
            poolBalanceEl.textContent = "0.00 ETH"; 
            spinResultEl.textContent = ""; 
        }

        async function updatePoolBalance() {
            if (!tokenPotContract || !tokenPotContract.runner || !tokenPotContract.runner.provider) {
                console.warn("updatePoolBalance: Kontrat veya provider yüklenmemiş.");
                return;
            }
            try {
                const currentProvider = tokenPotContract.runner.provider;
                const balance = await currentProvider.getBalance(YOUR_CONTRACT_ADDRESS);
                poolBalanceEl.textContent = `${ethers.formatEther(balance)} ETH`;
            } catch (error) {
                console.error("Havuz bakiyesi alınamadı:", error);
                poolBalanceEl.textContent = "Hata!";
            }
        }

        function spinReelsVisualUpdate(finalSymbolIndices) {
            let animationCycles = 0;
            const maxCycles = 10 + Math.floor(Math.random() * 5); 

            function animate() {
                reels.forEach((reelEl) => {
                    const randomSymbolIndex = Math.floor(Math.random() * SYMBOLS_EMOJI.length);
                    reelEl.textContent = SYMBOLS_EMOJI[randomSymbolIndex];
                });
                animationCycles++;
                if (animationCycles < maxCycles) {
                    setTimeout(animate, 80); 
                } else {
                    reels.forEach((reelEl, index) => {
                        const symbolIndex = finalSymbolIndices[index];
                        if (symbolIndex !== undefined && symbolIndex < SYMBOLS_EMOJI.length) {
                           reelEl.textContent = SYMBOLS_EMOJI[symbolIndex];
                        } else {
                           console.error("Geçersiz sembol indisi:", symbolIndex, "Makarada:", index);
                           reelEl.textContent = '❓';
                        }
                    });
                }
            }
            animate(); 
        }

        async function handleSpin() {
            if (!tokenPotContract || !signer) {
                showNotification('Hata', 'Lütfen önce cüzdanınızı bağlayın.');
                return;
            }

            const betAmountEthString = betAmountInput.value;
            if (!betAmountEthString || isNaN(parseFloat(betAmountEthString)) || parseFloat(betAmountEthString) <= 0) {
                showNotification('Geçersiz Bahis', 'Lütfen geçerli bir bahis miktarı girin (örn: 0.01).');
                return;
            }
            const betAmountEth = parseFloat(betAmountEthString);

            spinBtn.disabled = true;
            spinResultEl.textContent = "İşlem MetaMask'e gönderiliyor...";

            try {
                const betAmountWei = ethers.parseEther(betAmountEth.toString());
                
                const minBetWei = await tokenPotContract.minimumBet();
                if (betAmountWei < minBetWei) {
                    showNotification('Düşük Bahis', `Minimum bahis ${ethers.formatEther(minBetWei)} ETH olmalıdır.`);
                    spinResultEl.textContent = "";
                    spinBtn.disabled = false;
                    return;
                }
                
                const tx = await tokenPotContract.betAndSpin({ value: betAmountWei });
                
                spinResultEl.textContent = "İşlem ağa gönderildi, onay bekleniyor...";
                showNotification("İşlem Gönderildi", `İşlem ağa gönderildi. Lütfen onaylanmasını bekleyin.`);
            } catch (error) {
                console.error("Spin işlemi hatası:", error);
                let userMessage = "Spin işlemi sırasında bir hata oluştu.";
                 if (error.code === "ACTION_REJECTED") { 
                    userMessage = "İşlem kullanıcı tarafından reddedildi.";
                } else if (error.reason) {
                    userMessage += ` Sebep: ${error.reason}`;
                } else if (error.message) {
                    userMessage += ` Detay: ${error.message.substring(0,100)}...`
                }
                showNotification('İşlem Hatası', userMessage);
                spinResultEl.textContent = "";
                spinBtn.disabled = false;
            }
        }

        function listenForContractEvents() {
            if (!tokenPotContract) return;

            tokenPotContract.removeAllListeners("SpinResult");

            tokenPotContract.on("SpinResult", (requestId, player, betAmount, prizeAmount, resultSymbolsIndicesBigInt, event) => {
                console.log("SpinResult Event Alındı:", { 
                    requestId, 
                    player, 
                    betAmount: ethers.formatEther(betAmount), 
                    prizeAmount: ethers.formatEther(prizeAmount), 
                    resultSymbolsIndicesBigInt, 
                    txHash: event.log.transactionHash 
                });

                if (player.toLowerCase() === currentUserAddress.toLowerCase()) {
                    spinBtn.disabled = false;
                    
                    const finalIndices = resultSymbolsIndicesBigInt.map(index => Number(BigInt(index))); 
                    spinReelsVisualUpdate(finalIndices);

                    let message = "";
                    const isWin = BigInt(prizeAmount) > 0n; 
                    if (isWin) {
                        message = `🎉 Kazandınız! ${ethers.formatEther(prizeAmount)} ETH 🎉`;
                    } else {
                        message = `Kaybettiniz. Tekrar Deneyin!`;
                    }
                    spinResultEl.textContent = message;
                    showNotification("Spin Sonucu", message);

                    const txData = {
                        id: event.log.transactionHash,
                        user: player,
                        bet: parseFloat(ethers.formatEther(betAmount)),
                        win: isWin,
                        prize: parseFloat(ethers.formatEther(prizeAmount)),
                        symbols: finalIndices.map(index => SYMBOLS_EMOJI[index] || '❓'), 
                        timestamp: new Date().toISOString()
                    };
                    transactions.unshift(txData);
                    if (transactions.length > 50) transactions.pop();
                    renderTransactionList();
                    saveLocalTransactions();
                    updatePoolBalance();
                }
            });
            console.log("SpinResult event dinleyicisi aktif.");
        }

        function renderTransactionList() {
            transactionListEl.innerHTML = ''; 
            const displayLimit = 3; 
            const displayTransactions = transactions.slice(0, displayLimit); 

            if (displayTransactions.length === 0) {
                transactionListEl.innerHTML = '<p class="text-gray-400">Henüz işlem yok.</p>';
                return;
            }

            displayTransactions.forEach(tx => {
                const item = document.createElement('div');
                item.classList.add('tx-item', tx.win ? 'tx-win' : 'tx-lose');
                const shortAddress = tx.user ? `${tx.user.substring(0, 6)}...${tx.user.substring(tx.user.length - 4)}` : 'N/A';
                const statusIndicatorClass = tx.win ? 'status-win' : 'status-lose';
                
                let prizeText = '';
                if (tx.win) {
                    prizeText = ` Kazanç: ${tx.prize.toFixed(4)} ETH`;
                }

                item.innerHTML = `
                    <div class="flex justify-between items-center text-sm">
                        <div>
                            <span class="status-indicator ${statusIndicatorClass}"></span>
                            <span class="font-mono">${shortAddress}</span>
                        </div>
                        <span class="font-mono text-xs">${new Date(tx.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="mt-1 text-xs">
                        Bahis: ${tx.bet.toFixed(4)} ETH | Semboller: ${tx.symbols.join(' ')} ${prizeText}
                    </div>
                    <div class="mt-1 text-xs">
                        <a href="https://sepolia.explorer.zksync.io/tx/${tx.id}" target="_blank" class="text-blue-400 hover:text-blue-300">Tx: ${tx.id ? tx.id.substring(0,10) : 'N/A'}...</a>
                    </div>
                `;
                transactionListEl.appendChild(item);
            });
        }

        // --- EVENT LISTENERS ---
        connectWalletBtn.addEventListener('click', connectWallet);
        disconnectWalletBtn.addEventListener('click', disconnectWalletLogic); 
        spinBtn.addEventListener('click', handleSpin);

        // --- INITIALIZATION ---
        window.addEventListener('load', () => {
            loadLocalTransactions();
            disconnectWalletBtn.classList.add('hidden'); 

            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        showNotification('Hesap Bağlantısı Kesildi', 'MetaMask ile bağlantınız kesildi.');
                    } else {
                        showNotification('Hesap Değişti', 'MetaMask hesabı değişti. Lütfen cüzdanı tekrar bağlayın veya sayfayı yenileyin.');
                    }
                    disconnectWalletLogic();
                });

                window.ethereum.on('chainChanged', async (chainIdHex) => {
                    const chainIdDecimal = parseInt(chainIdHex, 16).toString();
                    if (chainIdDecimal !== TARGET_CHAIN_ID_DECIMAL) { 
                        showNotification('Ağ Değişti', `Lütfen MetaMask ağınızı ${TARGET_NETWORK_NAME} ağına geri değiştirin.`);
                        disconnectWalletLogic();
                    } else {
                        if(window.ethereum.selectedAddress && !signer) { // Eğer seçili adres varsa ama biz bağlı değilsek (sayfa yenilenmiş olabilir)
                           await connectWallet();
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>